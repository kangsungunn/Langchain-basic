name: Deploy app to EC2

on:
  push:
    branches:
      - main
    # paths í•„í„° ì œê±°: ëª¨ë“  í‘¸ì‹œì—ì„œ ì‹¤í–‰ (ë°°í¬ëŠ” app í´ë”ë§Œ í•˜ë¯€ë¡œ ì•ˆì „)
    # í•„ìš”ì‹œ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì—¬ íŠ¹ì • ê²½ë¡œë§Œ íŠ¸ë¦¬ê±°í•˜ë„ë¡ ì„¤ì • ê°€ëŠ¥
    # paths:
    #   - "app/**"
    #   - ".github/workflows/deploy.yml"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì€ í•­ìƒ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy FastAPI app to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app # ëª¨ë“  run ëª…ë ¹ì€ app/ ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ Error: EC2_HOST secret is not set"
            exit 1
          fi
          echo "ğŸ” Configuring SSH for EC2 host: $EC2_HOST"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "âš ï¸ Warning: ssh-keyscan failed, will use StrictHostKeyChecking=no"
          }
          chmod 600 ~/.ssh/known_hosts
          echo "âœ… SSH configuration ready"

      - name: Test SSH connection
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          echo "ğŸ§ª Testing SSH connection to $EC2_USER@$EC2_HOST"
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              $EC2_USER@$EC2_HOST "echo 'SSH connection successful!'" || {
            echo "âŒ SSH connection test failed"
            echo "Please check:"
            echo "  1. EC2 instance is running"
            echo "  2. Security group allows SSH (port 22) from GitHub Actions IPs"
            echo "  3. EC2_SSH_KEY secret is correct"
            exit 1
          }
          echo "âœ… SSH connection test passed"

      - name: Deploy app to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ]; then
            echo "âŒ Error: EC2_HOST or EC2_USER secret is not set"
            exit 1
          fi

          echo "ğŸš€ Deploying app folder to EC2..."
          echo "ğŸ“¦ Current working directory: $(pwd)"
          echo "ğŸ“ Contents to deploy:"
          ls -la

          # rsyncë¡œ app í´ë” ë‚´ìš©ë§Œ EC2ì— ë™ê¸°í™”
          # í˜„ì¬ working-directoryê°€ appì´ë¯€ë¡œ . ì„ ì‚¬ìš©
          rsync -avz --delete \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.pytest_cache' \
            --exclude='.git' \
            --exclude='*.log' \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=$HOME/.ssh/known_hosts" \
            ./ $EC2_USER@$EC2_HOST:/var/www/langchain/app/ || {
            echo "âŒ rsync failed!"
            exit 1
          }

          echo "âœ… Files synced to EC2"

          # EC2ì—ì„œ ë°°í¬ í›„ ì‘ì—… ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o ConnectTimeout=10 \
              $EC2_USER@$EC2_HOST bash -s << 'ENDSSH'
            set -e

            # GitHub Secretsì—ì„œ ì „ë‹¬ëœ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export OPENAI_API_KEY="$OPENAI_API_KEY"
            export POSTGRES_PASSWORD="$POSTGRES_PASSWORD"

            echo "ğŸš€ Starting deployment on EC2..."

            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ ë° ì •ë¦¬
            echo "ğŸ’¾ Checking disk space..."
            df -h /

            # ë””ìŠ¤í¬ ì‚¬ìš©ë¥  í™•ì¸ (ì•ˆì „í•œ ë°©ë²•)
            DISK_USAGE_RAW=$(df / | tail -1 | awk '{print $5}' 2>/dev/null)
            if [ -n "$DISK_USAGE_RAW" ]; then
              DISK_USAGE=$(echo "$DISK_USAGE_RAW" | sed 's/%//g' | tr -d '[:alpha:][:space:]')
            fi

            # DISK_USAGEê°€ ë¹„ì–´ìˆê±°ë‚˜ ìˆ«ìê°€ ì•„ë‹ˆë©´ df -hì—ì„œ ë‹¤ì‹œ ì¶”ì¶œ
            if [ -z "$DISK_USAGE" ] || ! echo "$DISK_USAGE" | grep -qE '^[0-9]+$'; then
              DISK_USAGE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//g' | tr -d '[:alpha:][:space:]')
            fi

            # ì—¬ì „íˆ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’
            if [ -z "$DISK_USAGE" ] || ! echo "$DISK_USAGE" | grep -qE '^[0-9]+$'; then
              DISK_USAGE="0"
            fi

            echo "   Disk usage: ${DISK_USAGE}%"

            # ë””ìŠ¤í¬ ê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ì •ë¦¬ (85% ì´ìƒ ì‚¬ìš© ì‹œ)
            if [ -n "$DISK_USAGE" ] && [ "$DISK_USAGE" -gt 85 ] 2>/dev/null; then
              echo "âš ï¸ Low disk space detected ($DISK_USAGE%), cleaning up..."
              # apt ìºì‹œ ì •ë¦¬
              sudo apt clean
              # ë¶ˆí•„ìš”í•œ íŒ¨í‚¤ì§€ ì œê±°
              sudo apt autoremove -y
              # ë¡œê·¸ íŒŒì¼ ì •ë¦¬
              sudo journalctl --vacuum-time=1d 2>/dev/null || true
              # ì„ì‹œ íŒŒì¼ ì •ë¦¬
              sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
              echo "âœ… Cleanup completed"
              df -h /
            fi

            # ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/www/langchain
            sudo chown -R ubuntu:ubuntu /var/www/langchain

            # Python ë²„ì „ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ Checking Python installation..."

            # Python ê²½ë¡œ ì§ì ‘ í™•ì¸ (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
            # /usr/bin/python3ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ì§ì ‘ ì‚¬ìš©
            if [ -x /usr/bin/python3 ]; then
              PYTHON_CMD="/usr/bin/python3"
              echo "âœ… Found Python 3 at: $PYTHON_CMD"
              # ì‹¤ì œë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
              if "$PYTHON_CMD" --version >/dev/null 2>&1; then
                echo "âœ… Python 3 is working: $($PYTHON_CMD --version 2>&1)"
              else
                echo "âš ï¸ /usr/bin/python3 exists but --version failed, trying alternative..."
                # python3.12 ì‹œë„
                if [ -x /usr/bin/python3.12 ]; then
                  PYTHON_CMD="/usr/bin/python3.12"
                  echo "âœ… Using Python 3.12: $PYTHON_CMD"
                else
                  echo "âŒ Python 3 found but doesn't work!"
                  exit 1
                fi
              fi
            elif [ -x /usr/bin/python3.12 ]; then
              PYTHON_CMD="/usr/bin/python3.12"
              echo "âœ… Found Python 3.12 at: $PYTHON_CMD"
            elif [ -x /usr/bin/python3.11 ]; then
              PYTHON_CMD="/usr/bin/python3.11"
              echo "âœ… Found Python 3.11 at: $PYTHON_CMD"
            elif command -v python3 >/dev/null 2>&1; then
              PYTHON_CMD="python3"
              echo "âœ… Found Python 3 in PATH: $PYTHON_CMD"
            else
              echo "âš ï¸ Python 3 not found! Installing Python 3 and venv..."
              sudo apt update
              sudo apt install -y python3 python3-pip python3-venv
              # ì„¤ì¹˜ í›„ ë‹¤ì‹œ í™•ì¸
              if [ -x /usr/bin/python3 ]; then
                PYTHON_CMD="/usr/bin/python3"
                echo "âœ… Python 3 installed: $PYTHON_CMD"
              elif command -v python3 >/dev/null 2>&1; then
                PYTHON_CMD="python3"
                echo "âœ… Python 3 installed: $PYTHON_CMD"
              else
                echo "âŒ Failed to install Python 3!"
                exit 1
              fi
            fi

            # PYTHON_CMD ìµœì¢… í™•ì¸
            if [ -z "$PYTHON_CMD" ]; then
              echo "âŒ CRITICAL: PYTHON_CMD is empty!"
              echo "Checking available Python installations:"
              ls -la /usr/bin/python* 2>/dev/null || echo "No Python found in /usr/bin"
              which python3 2>/dev/null || echo "python3 not in PATH"
              exit 1
            fi

            # Python ëª…ë ¹ì–´ê°€ ì‹¤ì œë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
            if ! "$PYTHON_CMD" --version >/dev/null 2>&1; then
              echo "âŒ Python command doesn't work: $PYTHON_CMD"
              echo "Trying to get version output:"
              "$PYTHON_CMD" --version 2>&1 || true
              exit 1
            fi

            echo "ğŸ” Final PYTHON_CMD: '$PYTHON_CMD'"
            echo "ğŸ” Python version: $($PYTHON_CMD --version 2>&1)"

            # Python ëª…ë ¹ì–´ê°€ ì‹¤ì œë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
            if ! "$PYTHON_CMD" --version &> /dev/null; then
              echo "âŒ Python command exists but doesn't work: $PYTHON_CMD"
              exit 1
            fi

            # Python ë²„ì „ í™•ì¸
            PYTHON_VERSION=$("$PYTHON_CMD" --version 2>&1 | awk '{print $2}' | cut -d. -f1,2)
            PYTHON_FULL_VERSION=$("$PYTHON_CMD" --version 2>&1)
            echo "   Detected Python version: $PYTHON_VERSION"
            echo "   Python full version: $PYTHON_FULL_VERSION"
            echo "   Python command: $PYTHON_CMD"
            PYTHON_ACTUAL_PATH=$(which "$PYTHON_CMD" 2>/dev/null || echo "$PYTHON_CMD")
            echo "   Python path: $PYTHON_ACTUAL_PATH"

            # python3-venv íŒ¨í‚¤ì§€ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ“¦ Ensuring python3-venv package is installed..."
            # Python ë²„ì „ì— ë§ëŠ” venv íŒ¨í‚¤ì§€ ì„¤ì¹˜
            if [ -n "$PYTHON_VERSION" ]; then
              # Python 3.12ì¸ ê²½ìš° python3.12-venv ì„¤ì¹˜ ì‹œë„
              VENV_PKG="python${PYTHON_VERSION}-venv"
              if ! dpkg -l | grep -q "^ii.*$VENV_PKG"; then
                echo "âš ï¸ Installing $VENV_PKG..."
                sudo apt update
                sudo apt install -y "$VENV_PKG" || {
                  echo "âš ï¸ $VENV_PKG not available, trying python3-venv..."
                  sudo apt install -y python3-venv
                }
              else
                echo "âœ… $VENV_PKG is already installed"
              fi
            else
              # ë²„ì „ì„ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë©´ ì¼ë°˜ python3-venv ì„¤ì¹˜
              if ! dpkg -l | grep -q "^ii.*python3-venv"; then
                echo "âš ï¸ Installing python3-venv..."
                sudo apt update
                sudo apt install -y python3-venv
              else
                echo "âœ… python3-venv is already installed"
              fi
            fi

            # ê°€ìƒ í™˜ê²½ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
            VENV_DIR="/var/www/langchain/venv"
            VENV_ACTIVATE="$VENV_DIR/bin/activate"

            # ê°€ìƒ í™˜ê²½ì´ ë¶ˆì™„ì „í•œ ê²½ìš° ì¬ìƒì„±
            if [ -d "$VENV_DIR" ] && [ ! -f "$VENV_ACTIVATE" ]; then
              echo "âš ï¸ Incomplete virtual environment detected, removing and recreating..."
              rm -rf "$VENV_DIR"
            fi

            if [ ! -d "$VENV_DIR" ]; then
              echo "ğŸ Creating Python virtual environment..."

              # PYTHON_CMD í™•ì¸
              if [ -z "$PYTHON_CMD" ]; then
                echo "âŒ PYTHON_CMD is not set! Finding Python..."
                PYTHON_CMD=$(command -v python3 || command -v python3.11 || echo "")
                if [ -z "$PYTHON_CMD" ]; then
                  echo "âŒ Python not found!"
                  exit 1
                fi
              fi

              echo "   Python command: $PYTHON_CMD"
              echo "   Virtual environment path: $VENV_DIR"

              # Python ëª…ë ¹ì–´ í™•ì¸
              if ! command -v "$PYTHON_CMD" &> /dev/null; then
                echo "âŒ Python command not found: $PYTHON_CMD"
                exit 1
              fi

              # ë””ë ‰í† ë¦¬ ìƒì„±
              sudo mkdir -p /var/www/langchain
              sudo chown -R ubuntu:ubuntu /var/www/langchain

              # ê°€ìƒ í™˜ê²½ ìƒì„±
              echo "   Attempting to create virtual environment..."
              if ! "$PYTHON_CMD" -m venv "$VENV_DIR" 2>&1; then
                echo "âš ï¸ Failed with $PYTHON_CMD, installing required packages..."
                # ensurepip ë¬¸ì œì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ venv íŒ¨í‚¤ì§€ ì¬ì„¤ì¹˜
                sudo apt update
                if [ -n "$PYTHON_VERSION" ]; then
                  # Ubuntu 24.04ì—ì„œëŠ” python3-distutilsê°€ í•„ìš” ì—†ì„ ìˆ˜ ìˆìŒ
                  sudo apt install -y "python${PYTHON_VERSION}-venv" || {
                    sudo apt install -y python3-venv
                  }
                else
                  sudo apt install -y python3-venv
                fi

                # ë‹¤ì‹œ ì‹œë„
                echo "   Retrying virtual environment creation..."
                if ! "$PYTHON_CMD" -m venv "$VENV_DIR" 2>&1; then
                  echo "âš ï¸ Still failed, trying with python3..."
                  if ! python3 -m venv "$VENV_DIR" 2>&1; then
                    echo "âŒ Virtual environment creation failed!"
                    echo "Python version: $($PYTHON_CMD --version 2>&1 || python3 --version)"
                    echo "Installed venv packages:"
                    dpkg -l | grep python.*venv || echo "No venv packages found"
                    exit 1
                  fi
                fi
              fi

              # ê°€ìƒ í™˜ê²½ ìƒì„± í™•ì¸
              if [ ! -d "$VENV_DIR" ]; then
                echo "âŒ Virtual environment directory not created!"
                exit 1
              fi

              if [ ! -f "$VENV_ACTIVATE" ]; then
                echo "âŒ Virtual environment activate script not found!"
                echo "Checking venv directory contents..."
                ls -la "$VENV_DIR" || echo "Directory does not exist"
                ls -la "$VENV_DIR/bin" 2>/dev/null || echo "bin directory does not exist"
                exit 1
              fi

              echo "âœ… Virtual environment created successfully"
            else
              # ê°€ìƒ í™˜ê²½ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš° ì™„ì „ì„± í™•ì¸
              if [ -f "$VENV_ACTIVATE" ]; then
                echo "âœ… Virtual environment already exists and is complete"
              else
                echo "âš ï¸ Virtual environment directory exists but is incomplete, recreating..."
                rm -rf "$VENV_DIR"
                $PYTHON_CMD -m venv "$VENV_DIR" || python3 -m venv "$VENV_DIR" || {
                  echo "âŒ Failed to recreate virtual environment"
                  exit 1
                }
                echo "âœ… Virtual environment recreated successfully"
              fi
            fi

            # app ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /var/www/langchain/app

            # ê°€ìƒ í™˜ê²½ í™œì„±í™”
            echo "ğŸ”Œ Activating virtual environment..."
            if [ -f "$VENV_ACTIVATE" ]; then
              source "$VENV_ACTIVATE"
              echo "âœ… Virtual environment activated"
              echo "   Python: $(which python)"
              echo "   Python version: $(python --version)"
            else
              echo "âŒ Virtual environment activate script not found at $VENV_ACTIVATE"
              echo "Virtual environment directory contents:"
              ls -la "$VENV_DIR" 2>/dev/null || echo "Directory does not exist"
              ls -la "$VENV_DIR/bin" 2>/dev/null || echo "bin directory does not exist"
              exit 1
            fi

            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            echo "ğŸ’¾ Checking disk space..."
            df -h / | tail -1
            AVAILABLE_SPACE=$(df / | tail -1 | awk '{print $4}')
            echo "   Available space: $AVAILABLE_SPACE"

            # pip ì—…ê·¸ë ˆì´ë“œ
            pip install --upgrade pip

            # ì˜ì¡´ì„± ì„¤ì¹˜ (app/requirements.txt ê¸°ì¤€)
            echo "ğŸ“¦ Installing dependencies..."
            if [ -f "requirements.txt" ]; then
              # CPU ëª¨ë“œ: GPU ê´€ë ¨ íŒ¨í‚¤ì§€ëŠ” CPU ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜
              echo "ğŸ”§ Installing CPU-optimized packages..."

              # 1. ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (GPU ê´€ë ¨ ì œì™¸)
              pip install \
                langchain-core>=0.3.0 \
                langchain>=0.3.0 \
                langchain-openai>=0.2.0 \
                langchain-postgres>=0.0.12 \
                pgvector>=0.3.0 \
                psycopg2-binary>=2.9.9 \
                langchain-text-splitters>=0.3.0 \
                fastapi>=0.115.0 \
                "uvicorn[standard]>=0.32.0" \
                python-dotenv>=1.0.0 || {
                echo "âŒ Failed to install core packages"
                exit 1
              }

              # 2. CPU ì „ìš© PyTorch ì„¤ì¹˜ (GPU ë²„ì „ë³´ë‹¤ í›¨ì”¬ ì‘ìŒ)
              echo "ğŸ”§ Installing CPU-only PyTorch..."
              pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu || {
                echo "âš ï¸ CPU PyTorch installation failed, trying without index..."
                pip install torch --index-url https://download.pytorch.org/whl/cpu || {
                  echo "âš ï¸ PyTorch installation failed, continuing without it..."
                }
              }

              # 3. transformers ë° ê¸°íƒ€ íŒ¨í‚¤ì§€ (bitsandbytes ì œì™¸)
              echo "ğŸ”§ Installing transformers and other packages..."
              pip install \
                transformers>=4.36.0 \
                langchain-huggingface>=0.0.1 \
                accelerate>=0.25.0 \
                sentencepiece>=0.1.99 || {
                echo "âš ï¸ Some packages failed to install, but continuing..."
              }

              # bitsandbytesëŠ” GPU ì „ìš©ì´ë¯€ë¡œ CPU ëª¨ë“œì—ì„œëŠ” ì œì™¸
              echo "â„¹ï¸ Skipping bitsandbytes (GPU-only package)"

              echo "âœ… Dependencies installation completed"
            else
              echo "âŒ Error: requirements.txt not found in app directory"
              exit 1
            fi

            # ì„¤ì¹˜ í›„ ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            echo "ğŸ’¾ Disk space after installation:"
            df -h / | tail -1

            # Midm ëª¨ë¸ í™•ì¸ ë° ë‹¤ìš´ë¡œë“œ (ì—†ëŠ” ê²½ìš°)
            if [ ! -d "models/midm" ] || [ -z "$(ls -A models/midm 2>/dev/null)" ]; then
              echo "âš ï¸ Midm model not found, downloading..."
              # Hugging Faceì—ì„œ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ (í•„ìš”ì‹œ)
              # python -c "from huggingface_hub import snapshot_download; snapshot_download('KT-AI/midm-2.0-mini-instruct', local_dir='models/midm')"
              echo "â„¹ï¸ Please download the model manually or configure automatic download"
            else
              echo "âœ… Midm model found"
            fi

            # Systemd ì„œë¹„ìŠ¤ ì„¤ì • (í•­ìƒ ì—…ë°ì´íŠ¸)
            echo "âš™ï¸  Updating systemd service..."

            # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/log/langchain
            sudo chown -R ubuntu:ubuntu /var/log/langchain

            # Systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸
            echo '[Unit]' | sudo tee /etc/systemd/system/langchain-api.service > /dev/null
            echo 'Description=LangChain FastAPI Application' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'After=network.target' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo '' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo '[Service]' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'Type=simple' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'User=ubuntu' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'WorkingDirectory=/var/www/langchain' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'Environment="PATH=/var/www/langchain/venv/bin"' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'Environment="PYTHONPATH=/var/www/langchain"' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            # EnvironmentFileì€ ì„ íƒì  (íŒŒì¼ì´ ì—†ì–´ë„ ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ë„ë¡)
            if [ -f /var/www/langchain/.env ]; then
              echo 'EnvironmentFile=/var/www/langchain/.env' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            fi
            echo 'ExecStart=/var/www/langchain/venv/bin/uvicorn app.api_server_refactored:app --host 0.0.0.0 --port 8000 --workers 2' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'Restart=always' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'RestartSec=10' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'TimeoutStartSec=60' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'TimeoutStopSec=30' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'StandardOutput=append:/var/log/langchain/access.log' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'StandardError=append:/var/log/langchain/error.log' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo '' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo '[Install]' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
            echo 'WantedBy=multi-user.target' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null

            # ì„œë¹„ìŠ¤ í™œì„±í™”
            sudo systemctl daemon-reload
            sudo systemctl enable langchain-api.service
            echo "âœ… Systemd service updated and enabled"

            # .env íŒŒì¼ í™•ì¸ ë° ìƒì„±/ì—…ë°ì´íŠ¸
            if [ ! -f /var/www/langchain/.env ]; then
              echo "âš ï¸ .env file not found, creating with GitHub Secrets..."

              # GitHub Secretsì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
              OPENAI_KEY="${OPENAI_API_KEY:-your_key_here}"
              POSTGRES_PASS="${POSTGRES_PASSWORD:-your_password_here}"

              # .env íŒŒì¼ ìƒì„±
              echo "OPENAI_API_KEY=$OPENAI_KEY" | sudo tee /var/www/langchain/.env > /dev/null
              echo 'POSTGRES_USER=neondb_owner' | sudo tee -a /var/www/langchain/.env > /dev/null
              echo "POSTGRES_PASSWORD=$POSTGRES_PASS" | sudo tee -a /var/www/langchain/.env > /dev/null
              echo 'POSTGRES_HOST=ep-mute-boat-a1sgw2su-pooler.ap-southeast-1.aws.neon.tech' | sudo tee -a /var/www/langchain/.env > /dev/null
              echo 'POSTGRES_PORT=5432' | sudo tee -a /var/www/langchain/.env > /dev/null
              echo 'POSTGRES_DB=neondb' | sudo tee -a /var/www/langchain/.env > /dev/null
              echo 'POSTGRES_SSLMODE=require' | sudo tee -a /var/www/langchain/.env > /dev/null
              echo 'LLM_PROVIDER=openai' | sudo tee -a /var/www/langchain/.env > /dev/null
              echo 'HOST=0.0.0.0' | sudo tee -a /var/www/langchain/.env > /dev/null
              echo 'PORT=8000' | sudo tee -a /var/www/langchain/.env > /dev/null
              echo 'ENVIRONMENT=production' | sudo tee -a /var/www/langchain/.env > /dev/null

              sudo chmod 600 /var/www/langchain/.env
              sudo chown ubuntu:ubuntu /var/www/langchain/.env

              if [ "$OPENAI_KEY" = "your_key_here" ]; then
                echo "âš ï¸ OPENAI_API_KEY not set in GitHub Secrets - using placeholder"
              else
                echo "âœ… .env file created with GitHub Secrets"
              fi
            else
              echo "âœ… .env file exists, updating values..."

              # OPENAI_API_KEY ì—…ë°ì´íŠ¸ (GitHub Secretsì—ì„œ)
              if [ -n "$OPENAI_API_KEY" ]; then
                sudo sed -i '/^OPENAI_API_KEY=/d' /var/www/langchain/.env
                echo "OPENAI_API_KEY=$OPENAI_API_KEY" | sudo tee -a /var/www/langchain/.env > /dev/null
                echo "âœ… OPENAI_API_KEY updated from GitHub Secrets"
              fi

              # POSTGRES_PASSWORD ì—…ë°ì´íŠ¸ (GitHub Secretsì—ì„œ)
              if [ -n "$POSTGRES_PASSWORD" ]; then
                sudo sed -i '/^POSTGRES_PASSWORD=/d' /var/www/langchain/.env
                echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" | sudo tee -a /var/www/langchain/.env > /dev/null
                echo "âœ… POSTGRES_PASSWORD updated from GitHub Secrets"
              fi

              # LLM_PROVIDERê°€ openaië¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
              if ! grep -q "LLM_PROVIDER=openai" /var/www/langchain/.env; then
                echo "âš ï¸ LLM_PROVIDER not set to openai, updating..."
                sudo sed -i '/^LLM_PROVIDER=/d' /var/www/langchain/.env
                echo 'LLM_PROVIDER=openai' | sudo tee -a /var/www/langchain/.env > /dev/null
                echo "âœ… LLM_PROVIDER set to openai"
              else
                echo "âœ… LLM_PROVIDER is already set to openai"
              fi
            fi

            # .env íŒŒì¼ ë‚´ìš© í™•ì¸ (ë¯¼ê°í•œ ì •ë³´ëŠ” ë§ˆìŠ¤í‚¹)
            echo "ğŸ“‹ Current .env configuration:"
            grep -E "^(LLM_PROVIDER|HOST|PORT|ENVIRONMENT)=" /var/www/langchain/.env || echo "âš ï¸ Some required variables not found"

            # ì„œë¹„ìŠ¤ ì‹œì‘/ì¬ì‹œì‘
            echo "ğŸ”„ Starting/Restarting service..."
            sudo systemctl daemon-reload
            sudo systemctl restart langchain-api.service

            # ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 30ì´ˆ)
            echo "â³ Waiting for service to start..."
            MAX_WAIT=30
            WAIT_COUNT=0
            SERVICE_READY=false

            while [ $WAIT_COUNT -lt $MAX_WAIT ]; do
              if sudo systemctl is-active --quiet langchain-api.service; then
                # í¬íŠ¸ê°€ ì‹¤ì œë¡œ ì—´ë ¸ëŠ”ì§€ í™•ì¸
                if command -v ss >/dev/null 2>&1; then
                  if sudo ss -tlnp | grep -q ":8000"; then
                    SERVICE_READY=true
                    break
                  fi
                elif command -v netstat >/dev/null 2>&1; then
                  if sudo netstat -tlnp | grep -q ":8000"; then
                    SERVICE_READY=true
                    break
                  fi
                else
                  # netstatê°€ ì—†ìœ¼ë©´ ì„œë¹„ìŠ¤ê°€ activeì¸ì§€ë§Œ í™•ì¸
                  SERVICE_READY=true
                  break
                fi
              fi
              sleep 1
              WAIT_COUNT=$((WAIT_COUNT + 1))
              echo "   Waiting... ($WAIT_COUNT/$MAX_WAIT seconds)"
            done

            echo "=== Service Status ==="
            sudo systemctl status langchain-api.service --no-pager | head -30

            # ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸
            echo "=== Recent Service Logs ==="
            sudo journalctl -u langchain-api.service -n 50 --no-pager || echo "No logs available"

            # ì—ëŸ¬ ë¡œê·¸ í™•ì¸
            echo "=== Error Logs ==="
            if [ -f /var/log/langchain/error.log ]; then
              tail -50 /var/log/langchain/error.log || echo "Error log file exists but cannot read"
            else
              echo "Error log file not found at /var/log/langchain/error.log"
            fi

            if [ "$SERVICE_READY" = "true" ]; then
              echo "âœ… Service is active and listening on port 8000!"

              # í¬íŠ¸ í™•ì¸ (ss ëª…ë ¹ì–´ ì‚¬ìš©, netstat ëŒ€ì‹ )
              echo "ğŸ” Verifying port 8000 is listening..."
              if command -v ss >/dev/null 2>&1; then
                sudo ss -tlnp | grep 8000 || echo "âš ï¸ Port 8000 not found in listening ports"
              elif command -v netstat >/dev/null 2>&1; then
                sudo netstat -tlnp | grep 8000 || echo "âš ï¸ Port 8000 not found in listening ports"
              else
                echo "âš ï¸ Installing net-tools for port checking..."
                sudo apt install -y net-tools 2>/dev/null || true
                sudo netstat -tlnp | grep 8000 || echo "âš ï¸ Port 8000 not found in listening ports"
              fi

              # í”„ë¡œì„¸ìŠ¤ í™•ì¸
              echo "ğŸ” Checking uvicorn processes..."
              ps aux | grep uvicorn | grep -v grep || echo "âš ï¸ No uvicorn processes found"

              # ë¡œì»¬ í—¬ìŠ¤ ì²´í¬ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
              echo "ğŸ¥ Testing local health endpoint..."
              HEALTH_CHECK_RETRIES=5
              HEALTH_CHECK_SUCCESS=false

              for i in $(seq 1 $HEALTH_CHECK_RETRIES); do
                sleep 2
                if curl -f http://localhost:8000/health >/dev/null 2>&1; then
                  echo "âœ… Local health check passed! (attempt $i/$HEALTH_CHECK_RETRIES)"
                  curl http://localhost:8000/health
                  HEALTH_CHECK_SUCCESS=true
                  break
                else
                  echo "âš ï¸ Health check attempt $i/$HEALTH_CHECK_RETRIES failed"
                  if [ $i -lt $HEALTH_CHECK_RETRIES ]; then
                    echo "   Retrying in 2 seconds..."
                  fi
                fi
              done

              if [ "$HEALTH_CHECK_SUCCESS" = "false" ]; then
                echo "âŒ Local health check failed after $HEALTH_CHECK_RETRIES attempts"
                echo "Trying to get detailed response:"
                curl -v http://localhost:8000/health 2>&1 | head -50 || echo "Connection failed"
                echo "=== Checking if port is actually listening ==="
                sudo ss -tlnp | grep 8000 || sudo netstat -tlnp | grep 8000 || echo "Port 8000 not listening"
                echo "=== Checking service logs for errors ==="
                sudo journalctl -u langchain-api.service -n 100 --no-pager | grep -i error || echo "No errors in logs"
              fi
            else
              echo "âŒ Service failed to start or is not listening on port 8000!"
              echo "=== Service Status (Full) ==="
              sudo systemctl status langchain-api.service --no-pager
              echo "=== Service File Content ==="
              sudo cat /etc/systemd/system/langchain-api.service
              echo "=== Recent Logs (Last 100 lines) ==="
              sudo journalctl -u langchain-api.service -n 100 --no-pager
              echo "=== Checking paths ==="
              echo "WorkingDirectory exists: $([ -d /var/www/langchain/app ] && echo 'yes' || echo 'no')"
              echo "Python exists: $([ -f /var/www/langchain/venv/bin/uvicorn ] && echo 'yes' || echo 'no')"
              echo "App file exists: $([ -f /var/www/langchain/app/api_server_refactored.py ] && echo 'yes' || echo 'no')"
              echo ".env exists: $([ -f /var/www/langchain/.env ] && echo 'yes' || echo 'no')"
              echo "=== Testing manual import ==="
              cd /var/www/langchain
              /var/www/langchain/venv/bin/python3 -c "import sys; sys.path.insert(0, '/var/www/langchain'); from app.api_server_refactored import app; print('Import successful')" 2>&1 || echo "Import failed"
              echo "=== Port status ==="
              sudo ss -tlnp | grep -E ':(80|8000)' || sudo netstat -tlnp | grep -E ':(80|8000)' || echo "No services on ports 80 or 8000"
              exit 1
            fi

            # Nginx ì„¤ì • í™•ì¸ ë° ì„¤ì • (ì„œë¹„ìŠ¤ê°€ ì™„ì „íˆ ì‹œì‘ëœ í›„ì—ë§Œ)
            # ì„œë¹„ìŠ¤ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸
            if [ "$HEALTH_CHECK_SUCCESS" = "true" ] || [ "$SERVICE_READY" = "true" ]; then
              echo "âœ… Service is ready, configuring Nginx..."

              if ! systemctl is-active --quiet nginx 2>/dev/null; then
                echo "âš ï¸ Nginx is not running, installing and configuring..."
                sudo apt update
                sudo apt install -y nginx
              fi

              # Nginx ì„¤ì • (ë°±ì—”ë“œ ì—°ê²° ì¬ì‹œë„ ë° íƒ€ì„ì•„ì›ƒ ì„¤ì • í¬í•¨)
              echo 'server {' | sudo tee /etc/nginx/sites-available/langchain > /dev/null
              echo '    listen 80;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    server_name _;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    client_max_body_size 50M;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    location / {' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_pass http://127.0.0.1:8000;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_http_version 1.1;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        # ë°±ì—”ë“œ ì—°ê²° ì¬ì‹œë„ ì„¤ì •' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_next_upstream error timeout http_502 http_503;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_next_upstream_tries 3;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_next_upstream_timeout 10s;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        # íƒ€ì„ì•„ì›ƒ ì„¤ì •' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_connect_timeout 10s;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_send_timeout 60s;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_read_timeout 60s;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        # í—¤ë” ì„¤ì •' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header Upgrade $http_upgrade;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header Connection "upgrade";' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header Host $host;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_cache_bypass $http_upgrade;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header X-Real-IP $remote_addr;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header X-Forwarded-Proto $scheme;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    }' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    location /health {' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_pass http://127.0.0.1:8000/health;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_connect_timeout 5s;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_read_timeout 5s;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        access_log off;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    }' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '}' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null

              sudo ln -sf /etc/nginx/sites-available/langchain /etc/nginx/sites-enabled/
              sudo rm -f /etc/nginx/sites-enabled/default

              # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸
              if sudo nginx -t; then
                sudo systemctl restart nginx
                sudo systemctl enable nginx
                echo "âœ… Nginx configured and restarted"

                # Nginx ì¬ì‹œì‘ í›„ ì ì‹œ ëŒ€ê¸°
                sleep 3

                # Nginxë¥¼ í†µí•œ health check
                echo "ğŸ¥ Testing health check via Nginx..."
                if curl -f http://localhost/health >/dev/null 2>&1; then
                  echo "âœ… Health check via Nginx passed!"
                  curl http://localhost/health
                else
                  echo "âš ï¸ Health check via Nginx failed, but service is running on port 8000"
                fi
              else
                echo "âŒ Nginx configuration test failed!"
                sudo nginx -t
                exit 1
              fi
            else
              echo "âš ï¸ Service is not ready, skipping Nginx configuration"
              echo "   Nginx will be configured on next deployment when service is healthy"
            fi
          ENDSSH

      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ Error: EC2_HOST secret is not set"
            exit 1
          fi

          echo "ğŸ¥ Performing health check on http://$EC2_HOST/health"

          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ (SSHë¡œ - ê°„ì†Œí™”)
          echo "ğŸ” Checking service status on EC2..."
          ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST bash << 'ENDSSH'
            echo "=== Service Status ==="
            sudo systemctl status langchain-api.service --no-pager | head -20 || echo "Service not found"
            echo -e "\n=== Port Status ==="
            sudo ss -tlnp | grep -E ':(80|8000)' || sudo netstat -tlnp | grep -E ':(80|8000)' || echo "No service listening"
            echo -e "\n=== Testing Local Connection ==="
            curl -s http://localhost:8000/health || echo "Local connection failed"
            curl -s http://localhost/health || echo "Nginx connection failed"
          ENDSSH

          # í—¬ìŠ¤ ì²´í¬ ì¬ì‹œë„ (ìµœëŒ€ 5ë²ˆ, ë” ê¸´ ëŒ€ê¸° ì‹œê°„)
          MAX_RETRIES=5
          RETRY_DELAY=15
          SUCCESS=false

          for i in $(seq 1 $MAX_RETRIES); do
            echo "ğŸ”„ Health check attempt $i/$MAX_RETRIES..."
            if [ $i -gt 1 ]; then
              sleep $RETRY_DELAY
            fi

            # ìƒì„¸í•œ ì‘ë‹µ ì •ë³´ ìˆ˜ì§‘
            response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 15 --max-time 30 "http://$EC2_HOST/health" 2>&1)
            curl_exit_code=$?

            if [ "$response" = "200" ]; then
              echo "âœ… Health check passed! (HTTP $response)"
              # ì‹¤ì œ ì‘ë‹µ ë‚´ìš©ë„ í™•ì¸
              health_response=$(curl -s "http://$EC2_HOST/health" 2>&1 || echo "")
              if [ -n "$health_response" ]; then
                echo "Response: $health_response"
              fi
              SUCCESS=true
              break
            else
              echo "âš ï¸ Health check failed with status: $response (curl exit code: $curl_exit_code)"
              if [ "$response" = "000" ] || [ $curl_exit_code -ne 0 ]; then
                echo "   Connection error - service may not be accessible from outside"
              elif [ "$response" = "502" ]; then
                echo "   502 Bad Gateway - Nginx cannot connect to backend (port 8000)"
              elif [ "$response" = "503" ]; then
                echo "   503 Service Unavailable - Service may be starting"
              fi

              if [ $i -lt $MAX_RETRIES ]; then
                echo "   Retrying in $RETRY_DELAY seconds..."
              fi
            fi
          done

          if [ "$SUCCESS" = "false" ]; then
            echo "âŒ Health check failed after $MAX_RETRIES attempts"
            echo ""
            echo "ğŸ” Detailed diagnostics:"
            ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'ENDSSH'
              echo "=== Service Status ==="
              sudo systemctl status langchain-api.service --no-pager | head -30

              echo -e "\n=== Service Logs (Last 50 lines) ==="
              sudo journalctl -u langchain-api.service -n 50 --no-pager

              echo -e "\n=== Nginx Status ==="
              sudo systemctl status nginx --no-pager | head -20

              echo -e "\n=== Nginx Error Logs ==="
              sudo tail -30 /var/log/nginx/error.log 2>/dev/null || echo "Nginx error log not found"

              echo -e "\n=== Port Status ==="
              if command -v ss >/dev/null 2>&1; then
                echo "Port 80:"
                sudo ss -tlnp | grep ":80 " || echo "  Not listening"
                echo "Port 8000:"
                sudo ss -tlnp | grep ":8000" || echo "  Not listening"
              else
                echo "Port 80:"
                sudo netstat -tlnp | grep ":80 " || echo "  Not listening"
                echo "Port 8000:"
                sudo netstat -tlnp | grep ":8000" || echo "  Not listening"
              fi

              echo -e "\n=== Uvicorn Processes ==="
              ps aux | grep uvicorn | grep -v grep || echo "No uvicorn processes"

              echo -e "\n=== Nginx Configuration ==="
              sudo cat /etc/nginx/sites-available/langchain 2>/dev/null || echo "Nginx config not found"
            ENDSSH

            echo ""
            echo "Please check:"
            echo "  1. Service is running: sudo systemctl status langchain-api.service"
            echo "  2. Nginx is running: sudo systemctl status nginx"
            echo "  3. Port 80 is listening: sudo ss -tlnp | grep 80"
            echo "  4. Port 8000 is listening: sudo ss -tlnp | grep 8000"
            echo "  5. Security group allows HTTP (port 80) from GitHub Actions IPs"
            echo "  6. Service logs: sudo journalctl -u langchain-api.service -n 100"
            echo "  7. Nginx error logs: sudo tail -50 /var/log/nginx/error.log"

            # ì„œë¹„ìŠ¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ê²½ê³ ë§Œ í•˜ê³  ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ
            if ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "systemctl list-unit-files | grep -q langchain-api.service"; then
              echo "âš ï¸ Service exists but health check failed - deployment may have issues"
              exit 1
            else
              echo "âš ï¸ Service not configured yet - skipping health check failure"
              echo "â„¹ï¸ This is expected for first-time deployment"
            fi
          fi

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ Deployment completed successfully!"
          else
            echo "âŒ Deployment failed!"
          fi
