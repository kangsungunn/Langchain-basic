name: Deploy app to EC2

on:
  push:
    branches:
      - main
    paths:
      - "app/**" # app í´ë” ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
      - ".github/workflows/deploy.yml" # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ì‹œì—ë„ ì‹¤í–‰
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì€ í•­ìƒ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy FastAPI app to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app # ëª¨ë“  run ëª…ë ¹ì€ app/ ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ Error: EC2_HOST secret is not set"
            exit 1
          fi
          echo "ğŸ” Configuring SSH for EC2 host: $EC2_HOST"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "âš ï¸ Warning: ssh-keyscan failed, will use StrictHostKeyChecking=no"
          }
          chmod 600 ~/.ssh/known_hosts
          echo "âœ… SSH configuration ready"

      - name: Test SSH connection
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          echo "ğŸ§ª Testing SSH connection to $EC2_USER@$EC2_HOST"
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              $EC2_USER@$EC2_HOST "echo 'SSH connection successful!'" || {
            echo "âŒ SSH connection test failed"
            echo "Please check:"
            echo "  1. EC2 instance is running"
            echo "  2. Security group allows SSH (port 22) from GitHub Actions IPs"
            echo "  3. EC2_SSH_KEY secret is correct"
            exit 1
          }
          echo "âœ… SSH connection test passed"

      - name: Deploy app to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ]; then
            echo "âŒ Error: EC2_HOST or EC2_USER secret is not set"
            exit 1
          fi

          echo "ğŸš€ Deploying app folder to EC2..."
          echo "ğŸ“¦ Current working directory: $(pwd)"
          echo "ğŸ“ Contents to deploy:"
          ls -la

          # rsyncë¡œ app í´ë” ë‚´ìš©ë§Œ EC2ì— ë™ê¸°í™”
          # í˜„ì¬ working-directoryê°€ appì´ë¯€ë¡œ . ì„ ì‚¬ìš©
          rsync -avz --delete \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.pytest_cache' \
            --exclude='.git' \
            --exclude='*.log' \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=$HOME/.ssh/known_hosts" \
            ./ $EC2_USER@$EC2_HOST:/var/www/langchain/app/ || {
            echo "âŒ rsync failed!"
            exit 1
          }

          echo "âœ… Files synced to EC2"

          # EC2ì—ì„œ ë°°í¬ í›„ ì‘ì—… ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o ConnectTimeout=10 \
              $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e

            echo "ğŸš€ Starting deployment on EC2..."

            # ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/www/langchain
            sudo chown -R ubuntu:ubuntu /var/www/langchain

            # Python ë²„ì „ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ Checking Python installation..."
            if ! command -v python3.11 &> /dev/null; then
              echo "âš ï¸ Python 3.11 not found, checking available Python version..."
              PYTHON_CMD=$(command -v python3 || echo "")
              if [ -z "$PYTHON_CMD" ]; then
                echo "âŒ Python 3 not found! Installing Python 3 and venv..."
                sudo apt update
                sudo apt install -y python3 python3-pip python3-venv
              else
                echo "âœ… Found: $PYTHON_CMD"
                PYTHON_VERSION=$($PYTHON_CMD --version)
                echo "   Version: $PYTHON_VERSION"
              fi
            else
              PYTHON_CMD="python3.11"
              echo "âœ… Python 3.11 found"
            fi

            # python3-venv íŒ¨í‚¤ì§€ í™•ì¸
            if ! $PYTHON_CMD -m venv --help &> /dev/null; then
              echo "âš ï¸ python3-venv not available, installing..."
              sudo apt update
              sudo apt install -y python3-venv
            fi

            # app ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /var/www/langchain/app

            # ê°€ìƒ í™˜ê²½ í™•ì¸ ë° ìƒì„± (app ë””ë ‰í† ë¦¬ ê¸°ì¤€)
            if [ ! -d "../venv" ]; then
              echo "ğŸ Creating Python virtual environment..."
              cd /var/www/langchain
              $PYTHON_CMD -m venv venv || {
                echo "âŒ Failed to create virtual environment"
                echo "Trying with system python3..."
                python3 -m venv venv || {
                  echo "âŒ Virtual environment creation failed!"
                  exit 1
                }
              }
              cd app
            fi

            # ê°€ìƒ í™˜ê²½ í™œì„±í™”
            echo "ğŸ”Œ Activating virtual environment..."
            source ../venv/bin/activate

            # pip ì—…ê·¸ë ˆì´ë“œ
            pip install --upgrade pip

            # ì˜ì¡´ì„± ì„¤ì¹˜ (app/requirements.txt ê¸°ì¤€)
            echo "ğŸ“¦ Installing dependencies..."
            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt
            else
              echo "âŒ Error: requirements.txt not found in app directory"
              exit 1
            fi

            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ìˆëŠ” ê²½ìš°)
            if systemctl list-unit-files | grep -q langchain-api.service; then
              echo "ğŸ”„ Restarting service..."
              sudo systemctl restart langchain-api.service

              # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
              sleep 3
              if sudo systemctl is-active --quiet langchain-api.service; then
                echo "âœ… Deployment successful!"
                sudo systemctl status langchain-api.service --no-pager
              else
                echo "âŒ Deployment failed - service not running!"
                sudo journalctl -u langchain-api.service -n 50 --no-pager
                exit 1
              fi
            else
              echo "âš ï¸ Warning: langchain-api.service not found"
              echo "Service will not be restarted. Please set up the service manually."
            fi
          ENDSSH

      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ Error: EC2_HOST secret is not set"
            exit 1
          fi
          echo "ğŸ¥ Performing health check on http://$EC2_HOST/health"
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" "http://$EC2_HOST/health" || echo "000")
          if [ "$response" -eq 200 ]; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed with status $response"
            exit 1
          fi

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ Deployment completed successfully!"
          else
            echo "âŒ Deployment failed!"
          fi
