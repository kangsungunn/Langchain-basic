name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy FastAPI to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå Error: EC2_HOST secret is not set"
            exit 1
          fi
          echo "üîç Configuring SSH for EC2 host: $EC2_HOST"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # ssh-keyscan ÏãúÎèÑ (Ïã§Ìå®Ìï¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ - StrictHostKeyChecking=noÎ°ú Ïö∞Ìöå)
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è Warning: ssh-keyscan failed, will use StrictHostKeyChecking=no"
          }
          chmod 600 ~/.ssh/known_hosts
          echo "‚úÖ SSH configuration ready"

      - name: Test SSH connection
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          echo "üß™ Testing SSH connection to $EC2_USER@$EC2_HOST"
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              $EC2_USER@$EC2_HOST "echo 'SSH connection successful!'" || {
            echo "‚ùå SSH connection test failed"
            echo "Please check:"
            echo "  1. EC2 instance is running"
            echo "  2. Security group allows SSH (port 22) from GitHub Actions IPs"
            echo "  3. EC2_SSH_KEY secret is correct"
            exit 1
          }
          echo "‚úÖ SSH connection test passed"

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ]; then
            echo "‚ùå Error: EC2_HOST or EC2_USER secret is not set"
            exit 1
          fi
          echo "üöÄ Connecting to $EC2_USER@$EC2_HOST"
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o ConnectTimeout=10 \
              -o ServerAliveInterval=60 \
              $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e

            echo "üöÄ Starting deployment..."

            # ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± (ÏóÜÎäî Í≤ΩÏö∞)
            if [ ! -d "/var/www/langchain" ]; then
              echo "üìÅ Creating application directory..."
              sudo mkdir -p /var/www/langchain
              sudo chown -R ubuntu:ubuntu /var/www/langchain
            fi

            # Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
            cd /var/www/langchain

            # Git Ï†ÄÏû•ÏÜå ÌôïÏù∏ Î∞è ÏóÖÎç∞Ïù¥Ìä∏
            if [ -d ".git" ]; then
              echo "üì• Pulling latest changes..."
              git pull origin main || {
                echo "‚ö†Ô∏è Git pull failed, trying to reset..."
                git fetch origin
                git reset --hard origin/main
              }
            else
              echo "‚ùå Error: Git repository not found in /var/www/langchain"
              echo "Please initialize the repository first:"
              echo "  cd /var/www/langchain"
              echo "  git clone https://github.com/kangsungunn/EC2-Î∞∞Ìè¨.git ."
              exit 1
            fi

            # Í∞ÄÏÉÅ ÌôòÍ≤Ω ÌôïÏù∏ Î∞è ÏÉùÏÑ±
            if [ ! -d "venv" ]; then
              echo "üêç Creating Python virtual environment..."
              python3.11 -m venv venv || python3 -m venv venv
            fi

            # Í∞ÄÏÉÅ ÌôòÍ≤Ω ÌôúÏÑ±Ìôî
            echo "üîå Activating virtual environment..."
            source venv/bin/activate

            # pip ÏóÖÍ∑∏Î†àÏù¥Îìú
            pip install --upgrade pip

            # ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
            echo "üì¶ Installing dependencies..."
            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt
            elif [ -f "app/requirements.txt" ]; then
              pip install -r app/requirements.txt
            else
              echo "‚ö†Ô∏è Warning: requirements.txt not found"
            fi

            # ÏÑúÎπÑÏä§ Ïû¨ÏãúÏûë (ÏûàÎäî Í≤ΩÏö∞)
            if systemctl list-unit-files | grep -q langchain-api.service; then
              echo "üîÑ Restarting service..."
              sudo systemctl restart langchain-api.service

              # ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏
              sleep 3
              if sudo systemctl is-active --quiet langchain-api.service; then
                echo "‚úÖ Deployment successful!"
                sudo systemctl status langchain-api.service --no-pager
              else
                echo "‚ùå Deployment failed - service not running!"
                sudo journalctl -u langchain-api.service -n 50 --no-pager
                exit 1
              fi
            else
              echo "‚ö†Ô∏è Warning: langchain-api.service not found"
              echo "Service will not be restarted. Please set up the service manually."
            fi
          ENDSSH

      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå Error: EC2_HOST secret is not set"
            exit 1
          fi
          echo "üè• Performing health check on http://$EC2_HOST/health"
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" "http://$EC2_HOST/health" || echo "000")
          if [ "$response" -eq 200 ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ùå Health check failed with status $response"
            exit 1
          fi

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "üéâ Deployment completed successfully!"
          else
            echo "‚ùå Deployment failed!"
          fi
