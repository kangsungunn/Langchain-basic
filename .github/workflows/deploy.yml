name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy FastAPI to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e

            echo "ðŸš€ Starting deployment..."

            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /var/www/langchain

            # Git pull
            if [ -d ".git" ]; then
              echo "ðŸ“¥ Pulling latest changes..."
              git pull origin main
            else
              echo "ðŸ“¥ Cloning repository..."
              cd /var/www
              sudo rm -rf langchain
              sudo mkdir langchain
              sudo chown ubuntu:ubuntu langchain
              cd langchain
              git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git .
            fi

            # ê°€ìƒ í™˜ê²½ í™œì„±í™”
            source venv/bin/activate

            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ðŸ“¦ Installing dependencies..."
            pip install -r requirements.txt

            # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
            echo "ðŸ”„ Restarting service..."
            sudo systemctl restart langchain-api.service

            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            sleep 3
            if sudo systemctl is-active --quiet langchain-api.service; then
              echo "âœ… Deployment successful!"
              sudo systemctl status langchain-api.service --no-pager
            else
              echo "âŒ Deployment failed!"
              sudo journalctl -u langchain-api.service -n 50 --no-pager
              exit 1
            fi
          ENDSSH

      - name: Health Check
        run: |
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}/health)
          if [ $response -eq 200 ]; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed with status $response"
            exit 1
          fi

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ðŸŽ‰ Deployment completed successfully!"
          else
            echo "âŒ Deployment failed!"
          fi
