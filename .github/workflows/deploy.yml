name: Deploy app to EC2

on:
  push:
    branches:
      - main
    # paths í•„í„° ì œê±°: ëª¨ë“  í‘¸ì‹œì—ì„œ ì‹¤í–‰ (ë°°í¬ëŠ” app í´ë”ë§Œ í•˜ë¯€ë¡œ ì•ˆì „)
    # í•„ìš”ì‹œ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì—¬ íŠ¹ì • ê²½ë¡œë§Œ íŠ¸ë¦¬ê±°í•˜ë„ë¡ ì„¤ì • ê°€ëŠ¥
    # paths:
    #   - "app/**"
    #   - ".github/workflows/deploy.yml"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì€ í•­ìƒ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy FastAPI app to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app # ëª¨ë“  run ëª…ë ¹ì€ app/ ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ Error: EC2_HOST secret is not set"
            exit 1
          fi
          echo "ğŸ” Configuring SSH for EC2 host: $EC2_HOST"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "âš ï¸ Warning: ssh-keyscan failed, will use StrictHostKeyChecking=no"
          }
          chmod 600 ~/.ssh/known_hosts
          echo "âœ… SSH configuration ready"

      - name: Test SSH connection
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          echo "ğŸ§ª Testing SSH connection to $EC2_USER@$EC2_HOST"
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              $EC2_USER@$EC2_HOST "echo 'SSH connection successful!'" || {
            echo "âŒ SSH connection test failed"
            echo "Please check:"
            echo "  1. EC2 instance is running"
            echo "  2. Security group allows SSH (port 22) from GitHub Actions IPs"
            echo "  3. EC2_SSH_KEY secret is correct"
            exit 1
          }
          echo "âœ… SSH connection test passed"

      - name: Deploy app to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ]; then
            echo "âŒ Error: EC2_HOST or EC2_USER secret is not set"
            exit 1
          fi

          echo "ğŸš€ Deploying app folder to EC2..."
          echo "ğŸ“¦ Current working directory: $(pwd)"
          echo "ğŸ“ Contents to deploy:"
          ls -la

          # rsyncë¡œ app í´ë” ë‚´ìš©ë§Œ EC2ì— ë™ê¸°í™”
          # í˜„ì¬ working-directoryê°€ appì´ë¯€ë¡œ . ì„ ì‚¬ìš©
          rsync -avz --delete \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.pytest_cache' \
            --exclude='.git' \
            --exclude='*.log' \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=$HOME/.ssh/known_hosts" \
            ./ $EC2_USER@$EC2_HOST:/var/www/langchain/app/ || {
            echo "âŒ rsync failed!"
            exit 1
          }

          echo "âœ… Files synced to EC2"

          # EC2ì—ì„œ ë°°í¬ í›„ ì‘ì—… ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o ConnectTimeout=10 \
              $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e

            echo "ğŸš€ Starting deployment on EC2..."

            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ ë° ì •ë¦¬
            echo "ğŸ’¾ Checking disk space..."
            df -h /
            AVAILABLE_SPACE=$(df / | tail -1 | awk '{print $4}')
            echo "   Available space: $AVAILABLE_SPACE"

            # ë””ìŠ¤í¬ ê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ì •ë¦¬
            if [ "$(df / | tail -1 | awk '{print $4}' | sed 's/[^0-9]//g')" -lt 1000000 ]; then
              echo "âš ï¸ Low disk space detected, cleaning up..."
              # apt ìºì‹œ ì •ë¦¬
              sudo apt clean
              # ë¶ˆí•„ìš”í•œ íŒ¨í‚¤ì§€ ì œê±°
              sudo apt autoremove -y
              # ë¡œê·¸ íŒŒì¼ ì •ë¦¬
              sudo journalctl --vacuum-time=1d
              echo "âœ… Cleanup completed"
              df -h /
            fi

            # ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/www/langchain
            sudo chown -R ubuntu:ubuntu /var/www/langchain

            # Python ë²„ì „ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ Checking Python installation..."
            if ! command -v python3.11 &> /dev/null; then
              echo "âš ï¸ Python 3.11 not found, checking available Python version..."
              PYTHON_CMD=$(command -v python3 || echo "")
              if [ -z "$PYTHON_CMD" ]; then
                echo "âŒ Python 3 not found! Installing Python 3 and venv..."
                sudo apt update
                sudo apt install -y python3 python3-pip python3-venv
              else
                echo "âœ… Found: $PYTHON_CMD"
                PYTHON_VERSION=$($PYTHON_CMD --version)
                echo "   Version: $PYTHON_VERSION"
              fi
            else
              PYTHON_CMD="python3.11"
              echo "âœ… Python 3.11 found"
            fi

            # Python ë²„ì „ í™•ì¸ ë° venv íŒ¨í‚¤ì§€ ì„¤ì¹˜
            PYTHON_VERSION=$($PYTHON_CMD --version 2>&1 | awk '{print $2}' | cut -d. -f1,2)
            echo "   Detected Python version: $PYTHON_VERSION"

            # python3-venv íŒ¨í‚¤ì§€ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ“¦ Ensuring python3-venv package is installed..."
            # Python ë²„ì „ì— ë§ëŠ” venv íŒ¨í‚¤ì§€ ì„¤ì¹˜
            if [ -n "$PYTHON_VERSION" ]; then
              # Python 3.12ì¸ ê²½ìš° python3.12-venv ì„¤ì¹˜ ì‹œë„
              VENV_PKG="python${PYTHON_VERSION}-venv"
              if ! dpkg -l | grep -q "^ii.*$VENV_PKG"; then
                echo "âš ï¸ Installing $VENV_PKG..."
                sudo apt update
                sudo apt install -y "$VENV_PKG" || {
                  echo "âš ï¸ $VENV_PKG not available, trying python3-venv..."
                  sudo apt install -y python3-venv
                }
              else
                echo "âœ… $VENV_PKG is already installed"
              fi
            else
              # ë²„ì „ì„ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë©´ ì¼ë°˜ python3-venv ì„¤ì¹˜
              if ! dpkg -l | grep -q "^ii.*python3-venv"; then
                echo "âš ï¸ Installing python3-venv..."
                sudo apt update
                sudo apt install -y python3-venv
              else
                echo "âœ… python3-venv is already installed"
              fi
            fi

            # ê°€ìƒ í™˜ê²½ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
            VENV_DIR="/var/www/langchain/venv"
            VENV_ACTIVATE="$VENV_DIR/bin/activate"

            # ê°€ìƒ í™˜ê²½ì´ ë¶ˆì™„ì „í•œ ê²½ìš° ì¬ìƒì„±
            if [ -d "$VENV_DIR" ] && [ ! -f "$VENV_ACTIVATE" ]; then
              echo "âš ï¸ Incomplete virtual environment detected, removing and recreating..."
              rm -rf "$VENV_DIR"
            fi

            if [ ! -d "$VENV_DIR" ]; then
              echo "ğŸ Creating Python virtual environment..."
              echo "   Python command: $PYTHON_CMD"
              echo "   Virtual environment path: $VENV_DIR"

              # ë””ë ‰í† ë¦¬ ìƒì„±
              sudo mkdir -p /var/www/langchain
              sudo chown -R ubuntu:ubuntu /var/www/langchain

              # ê°€ìƒ í™˜ê²½ ìƒì„±
              echo "   Attempting to create virtual environment..."
              if ! $PYTHON_CMD -m venv "$VENV_DIR" 2>&1; then
                echo "âš ï¸ Failed with $PYTHON_CMD, installing required packages..."
                # ensurepip ë¬¸ì œì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ venv íŒ¨í‚¤ì§€ ì¬ì„¤ì¹˜
                sudo apt update
                if [ -n "$PYTHON_VERSION" ]; then
                  sudo apt install -y "python${PYTHON_VERSION}-venv" "python${PYTHON_VERSION}-distutils" || {
                    sudo apt install -y python3-venv python3-distutils
                  }
                else
                  sudo apt install -y python3-venv python3-distutils
                fi

                # ë‹¤ì‹œ ì‹œë„
                echo "   Retrying virtual environment creation..."
                if ! $PYTHON_CMD -m venv "$VENV_DIR" 2>&1; then
                  echo "âš ï¸ Still failed, trying with python3..."
                  if ! python3 -m venv "$VENV_DIR" 2>&1; then
                    echo "âŒ Virtual environment creation failed!"
                    echo "Python version: $($PYTHON_CMD --version 2>&1 || python3 --version)"
                    echo "Installed venv packages:"
                    dpkg -l | grep python.*venv || echo "No venv packages found"
                    exit 1
                  fi
                fi
              fi

              # ê°€ìƒ í™˜ê²½ ìƒì„± í™•ì¸
              if [ ! -d "$VENV_DIR" ]; then
                echo "âŒ Virtual environment directory not created!"
                exit 1
              fi

              if [ ! -f "$VENV_ACTIVATE" ]; then
                echo "âŒ Virtual environment activate script not found!"
                echo "Checking venv directory contents..."
                ls -la "$VENV_DIR" || echo "Directory does not exist"
                ls -la "$VENV_DIR/bin" 2>/dev/null || echo "bin directory does not exist"
                exit 1
              fi

              echo "âœ… Virtual environment created successfully"
            else
              # ê°€ìƒ í™˜ê²½ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš° ì™„ì „ì„± í™•ì¸
              if [ -f "$VENV_ACTIVATE" ]; then
                echo "âœ… Virtual environment already exists and is complete"
              else
                echo "âš ï¸ Virtual environment directory exists but is incomplete, recreating..."
                rm -rf "$VENV_DIR"
                $PYTHON_CMD -m venv "$VENV_DIR" || python3 -m venv "$VENV_DIR" || {
                  echo "âŒ Failed to recreate virtual environment"
                  exit 1
                }
                echo "âœ… Virtual environment recreated successfully"
              fi
            fi

            # app ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /var/www/langchain/app

            # ê°€ìƒ í™˜ê²½ í™œì„±í™”
            echo "ğŸ”Œ Activating virtual environment..."
            if [ -f "$VENV_ACTIVATE" ]; then
              source "$VENV_ACTIVATE"
              echo "âœ… Virtual environment activated"
              echo "   Python: $(which python)"
              echo "   Python version: $(python --version)"
            else
              echo "âŒ Virtual environment activate script not found at $VENV_ACTIVATE"
              echo "Virtual environment directory contents:"
              ls -la "$VENV_DIR" 2>/dev/null || echo "Directory does not exist"
              ls -la "$VENV_DIR/bin" 2>/dev/null || echo "bin directory does not exist"
              exit 1
            fi

            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            echo "ğŸ’¾ Checking disk space..."
            df -h / | tail -1
            AVAILABLE_SPACE=$(df / | tail -1 | awk '{print $4}')
            echo "   Available space: $AVAILABLE_SPACE"

            # pip ì—…ê·¸ë ˆì´ë“œ
            pip install --upgrade pip

            # ì˜ì¡´ì„± ì„¤ì¹˜ (app/requirements.txt ê¸°ì¤€)
            echo "ğŸ“¦ Installing dependencies..."
            if [ -f "requirements.txt" ]; then
              # CPU ëª¨ë“œ: GPU ê´€ë ¨ íŒ¨í‚¤ì§€ëŠ” CPU ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜
              echo "ğŸ”§ Installing CPU-optimized packages..."

              # 1. ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (GPU ê´€ë ¨ ì œì™¸)
              pip install \
                langchain-core>=0.3.0 \
                langchain>=0.3.0 \
                langchain-openai>=0.2.0 \
                langchain-postgres>=0.0.12 \
                pgvector>=0.3.0 \
                psycopg2-binary>=2.9.9 \
                langchain-text-splitters>=0.3.0 \
                fastapi>=0.115.0 \
                "uvicorn[standard]>=0.32.0" \
                python-dotenv>=1.0.0 || {
                echo "âŒ Failed to install core packages"
                exit 1
              }

              # 2. CPU ì „ìš© PyTorch ì„¤ì¹˜ (GPU ë²„ì „ë³´ë‹¤ í›¨ì”¬ ì‘ìŒ)
              echo "ğŸ”§ Installing CPU-only PyTorch..."
              pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu || {
                echo "âš ï¸ CPU PyTorch installation failed, trying without index..."
                pip install torch --index-url https://download.pytorch.org/whl/cpu || {
                  echo "âš ï¸ PyTorch installation failed, continuing without it..."
                }
              }

              # 3. transformers ë° ê¸°íƒ€ íŒ¨í‚¤ì§€ (bitsandbytes ì œì™¸)
              echo "ğŸ”§ Installing transformers and other packages..."
              pip install \
                transformers>=4.36.0 \
                langchain-huggingface>=0.0.1 \
                accelerate>=0.25.0 \
                sentencepiece>=0.1.99 || {
                echo "âš ï¸ Some packages failed to install, but continuing..."
              }

              # bitsandbytesëŠ” GPU ì „ìš©ì´ë¯€ë¡œ CPU ëª¨ë“œì—ì„œëŠ” ì œì™¸
              echo "â„¹ï¸ Skipping bitsandbytes (GPU-only package)"

              echo "âœ… Dependencies installation completed"
            else
              echo "âŒ Error: requirements.txt not found in app directory"
              exit 1
            fi

            # ì„¤ì¹˜ í›„ ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            echo "ğŸ’¾ Disk space after installation:"
            df -h / | tail -1

            # Systemd ì„œë¹„ìŠ¤ í™•ì¸ ë° ì„¤ì •
            if ! systemctl list-unit-files | grep -q langchain-api.service; then
              echo "âš™ï¸  Creating systemd service..."

              # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
              sudo mkdir -p /var/log/langchain
              sudo chown -R ubuntu:ubuntu /var/log/langchain

              # Systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
              echo '[Unit]' | sudo tee /etc/systemd/system/langchain-api.service > /dev/null
              echo 'Description=LangChain FastAPI Application' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo 'After=network.target' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo '' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo '[Service]' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo 'Type=simple' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo 'User=ubuntu' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo 'WorkingDirectory=/var/www/langchain/app' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo 'Environment="PATH=/var/www/langchain/venv/bin"' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              # EnvironmentFileì€ ì„ íƒì  (íŒŒì¼ì´ ì—†ì–´ë„ ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ë„ë¡)
              if [ -f /var/www/langchain/.env ]; then
                echo 'EnvironmentFile=/var/www/langchain/.env' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              fi
              echo 'ExecStart=/var/www/langchain/venv/bin/uvicorn api_server_refactored:app --host 0.0.0.0 --port 8000 --workers 2' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo 'Restart=always' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo 'RestartSec=10' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo 'StandardOutput=append:/var/log/langchain/access.log' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo 'StandardError=append:/var/log/langchain/error.log' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo '' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo '[Install]' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null
              echo 'WantedBy=multi-user.target' | sudo tee -a /etc/systemd/system/langchain-api.service > /dev/null

              # ì„œë¹„ìŠ¤ í™œì„±í™”
              sudo systemctl daemon-reload
              sudo systemctl enable langchain-api.service
              echo "âœ… Systemd service created and enabled"
            fi

            # .env íŒŒì¼ í™•ì¸ ë° ìƒì„± (ì—†ëŠ” ê²½ìš°)
            if [ ! -f /var/www/langchain/.env ]; then
              echo "âš ï¸ .env file not found, creating template..."
              sudo tee /var/www/langchain/.env > /dev/null << 'ENVEOF'
OPENAI_API_KEY=your_key_here
POSTGRES_USER=neondb_owner
POSTGRES_PASSWORD=your_password_here
POSTGRES_HOST=ep-mute-boat-a1sgw2su-pooler.ap-southeast-1.aws.neon.tech
POSTGRES_PORT=5432
POSTGRES_DB=neondb
LLM_PROVIDER=openai
HOST=0.0.0.0
PORT=8000
ENVIRONMENT=production
ENVEOF
              sudo chmod 600 /var/www/langchain/.env
              sudo chown ubuntu:ubuntu /var/www/langchain/.env
              echo "âš ï¸ Created .env template - please update with actual values!"
            else
              echo "âœ… .env file exists"
            fi

            # ì„œë¹„ìŠ¤ ì‹œì‘/ì¬ì‹œì‘
            echo "ğŸ”„ Starting/Restarting service..."
            sudo systemctl daemon-reload
            sudo systemctl restart langchain-api.service

            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            sleep 5
            if sudo systemctl is-active --quiet langchain-api.service; then
              echo "âœ… Service is running!"
              sudo systemctl status langchain-api.service --no-pager | head -20

              # í¬íŠ¸ í™•ì¸
              echo "ğŸ” Checking if service is listening on port 8000..."
              sudo netstat -tlnp | grep 8000 || ss -tlnp | grep 8000 || echo "âš ï¸ Port 8000 not found in listening ports"

              # ë¡œì»¬ í—¬ìŠ¤ ì²´í¬
              echo "ğŸ¥ Testing local health endpoint..."
              curl -f http://localhost:8000/health || echo "âš ï¸ Local health check failed"
            else
              echo "âŒ Service failed to start!"
              echo "=== Service Status ==="
              sudo systemctl status langchain-api.service --no-pager
              echo "=== Service File Content ==="
              sudo cat /etc/systemd/system/langchain-api.service
              echo "=== Recent Logs ==="
              sudo journalctl -u langchain-api.service -n 50 --no-pager
              echo "=== Checking paths ==="
              echo "WorkingDirectory exists: $([ -d /var/www/langchain/app ] && echo 'yes' || echo 'no')"
              echo "Python exists: $([ -f /var/www/langchain/venv/bin/uvicorn ] && echo 'yes' || echo 'no')"
              echo "App file exists: $([ -f /var/www/langchain/app/api_server_refactored.py ] && echo 'yes' || echo 'no')"
              echo ".env exists: $([ -f /var/www/langchain/.env ] && echo 'yes' || echo 'no')"
              exit 1
            fi

            # Nginx ì„¤ì • í™•ì¸ ë° ì„¤ì •
            if ! systemctl is-active --quiet nginx 2>/dev/null; then
              echo "âš ï¸ Nginx is not running, installing and configuring..."
              sudo apt update
              sudo apt install -y nginx

              # Nginx ì„¤ì •
              echo 'server {' | sudo tee /etc/nginx/sites-available/langchain > /dev/null
              echo '    listen 80;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    server_name _;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    client_max_body_size 50M;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    location / {' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_pass http://127.0.0.1:8000;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_http_version 1.1;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header Upgrade $http_upgrade;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header Connection "upgrade";' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header Host $host;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_cache_bypass $http_upgrade;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header X-Real-IP $remote_addr;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_set_header X-Forwarded-Proto $scheme;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    }' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    location /health {' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        proxy_pass http://127.0.0.1:8000/health;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '        access_log off;' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '    }' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null
              echo '}' | sudo tee -a /etc/nginx/sites-available/langchain > /dev/null

              sudo ln -sf /etc/nginx/sites-available/langchain /etc/nginx/sites-enabled/
              sudo rm -f /etc/nginx/sites-enabled/default
              sudo nginx -t && sudo systemctl restart nginx
              sudo systemctl enable nginx
              echo "âœ… Nginx configured and started"
            else
              echo "âœ… Nginx is already running"
            fi
          ENDSSH

      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ Error: EC2_HOST secret is not set"
            exit 1
          fi

          echo "ğŸ¥ Performing health check on http://$EC2_HOST/health"

          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ (SSHë¡œ)
          echo "ğŸ” Checking service status on EC2..."
          ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'ENDSSH'
            echo "=== Service Status ==="
            if systemctl list-unit-files | grep -q langchain-api.service; then
              sudo systemctl status langchain-api.service --no-pager | head -10
            else
              echo "âš ï¸ langchain-api.service not found"
            fi

            echo -e "\n=== Nginx Status ==="
            sudo systemctl status nginx --no-pager | head -10 || echo "Nginx not running"

            echo -e "\n=== Port Listening ==="
            sudo netstat -tlnp | grep -E ':(80|8000)' || echo "No service listening on port 80 or 8000"
          ENDSSH

          # í—¬ìŠ¤ ì²´í¬ ì¬ì‹œë„ (ìµœëŒ€ 3ë²ˆ)
          MAX_RETRIES=3
          RETRY_DELAY=10
          SUCCESS=false

          for i in $(seq 1 $MAX_RETRIES); do
            echo "ğŸ”„ Health check attempt $i/$MAX_RETRIES..."
            sleep $RETRY_DELAY

            response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 "http://$EC2_HOST/health" 2>&1 || echo "000")

            if [ "$response" = "200" ]; then
              echo "âœ… Health check passed!"
              SUCCESS=true
              break
            else
              echo "âš ï¸ Health check failed with status: $response"
              if [ $i -lt $MAX_RETRIES ]; then
                echo "   Retrying in $RETRY_DELAY seconds..."
              fi
            fi
          done

          if [ "$SUCCESS" = "false" ]; then
            echo "âŒ Health check failed after $MAX_RETRIES attempts"
            echo "Please check:"
            echo "  1. Service is running: sudo systemctl status langchain-api.service"
            echo "  2. Nginx is running: sudo systemctl status nginx"
            echo "  3. Port 80 is open: sudo netstat -tlnp | grep 80"
            echo "  4. Security group allows HTTP (port 80)"
            # ì„œë¹„ìŠ¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ê²½ê³ ë§Œ í•˜ê³  ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ
            if ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "systemctl list-unit-files | grep -q langchain-api.service"; then
              echo "âš ï¸ Service exists but health check failed - deployment may have issues"
              exit 1
            else
              echo "âš ï¸ Service not configured yet - skipping health check failure"
              echo "â„¹ï¸ This is expected for first-time deployment"
            fi
          fi

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ Deployment completed successfully!"
          else
            echo "âŒ Deployment failed!"
          fi
