name: Deploy app to EC2

on:
  push:
    branches:
      - main
    paths:
      - "app/**" # app í´ë” ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
      - ".github/workflows/deploy.yml" # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ì‹œì—ë„ ì‹¤í–‰
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì€ í•­ìƒ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy FastAPI app to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app # ëª¨ë“  run ëª…ë ¹ì€ app/ ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ Error: EC2_HOST secret is not set"
            exit 1
          fi
          echo "ğŸ” Configuring SSH for EC2 host: $EC2_HOST"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "âš ï¸ Warning: ssh-keyscan failed, will use StrictHostKeyChecking=no"
          }
          chmod 600 ~/.ssh/known_hosts
          echo "âœ… SSH configuration ready"

      - name: Test SSH connection
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          echo "ğŸ§ª Testing SSH connection to $EC2_USER@$EC2_HOST"
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              $EC2_USER@$EC2_HOST "echo 'SSH connection successful!'" || {
            echo "âŒ SSH connection test failed"
            echo "Please check:"
            echo "  1. EC2 instance is running"
            echo "  2. Security group allows SSH (port 22) from GitHub Actions IPs"
            echo "  3. EC2_SSH_KEY secret is correct"
            exit 1
          }
          echo "âœ… SSH connection test passed"

      - name: Deploy app to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ]; then
            echo "âŒ Error: EC2_HOST or EC2_USER secret is not set"
            exit 1
          fi

          echo "ğŸš€ Deploying app folder to EC2..."
          echo "ğŸ“¦ Current working directory: $(pwd)"
          echo "ğŸ“ Contents to deploy:"
          ls -la

          # rsyncë¡œ app í´ë” ë‚´ìš©ë§Œ EC2ì— ë™ê¸°í™”
          # í˜„ì¬ working-directoryê°€ appì´ë¯€ë¡œ . ì„ ì‚¬ìš©
          rsync -avz --delete \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.pytest_cache' \
            --exclude='.git' \
            --exclude='*.log' \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=$HOME/.ssh/known_hosts" \
            ./ $EC2_USER@$EC2_HOST:/var/www/langchain/app/ || {
            echo "âŒ rsync failed!"
            exit 1
          }

          echo "âœ… Files synced to EC2"

          # EC2ì—ì„œ ë°°í¬ í›„ ì‘ì—… ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o ConnectTimeout=10 \
              $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e

            echo "ğŸš€ Starting deployment on EC2..."

            # ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/www/langchain
            sudo chown -R ubuntu:ubuntu /var/www/langchain

            # Python ë²„ì „ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ Checking Python installation..."
            if ! command -v python3.11 &> /dev/null; then
              echo "âš ï¸ Python 3.11 not found, checking available Python version..."
              PYTHON_CMD=$(command -v python3 || echo "")
              if [ -z "$PYTHON_CMD" ]; then
                echo "âŒ Python 3 not found! Installing Python 3 and venv..."
                sudo apt update
                sudo apt install -y python3 python3-pip python3-venv
              else
                echo "âœ… Found: $PYTHON_CMD"
                PYTHON_VERSION=$($PYTHON_CMD --version)
                echo "   Version: $PYTHON_VERSION"
              fi
            else
              PYTHON_CMD="python3.11"
              echo "âœ… Python 3.11 found"
            fi

            # Python ë²„ì „ í™•ì¸ ë° venv íŒ¨í‚¤ì§€ ì„¤ì¹˜
            PYTHON_VERSION=$($PYTHON_CMD --version 2>&1 | awk '{print $2}' | cut -d. -f1,2)
            echo "   Detected Python version: $PYTHON_VERSION"

            # python3-venv íŒ¨í‚¤ì§€ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ“¦ Ensuring python3-venv package is installed..."
            # Python ë²„ì „ì— ë§ëŠ” venv íŒ¨í‚¤ì§€ ì„¤ì¹˜
            if [ -n "$PYTHON_VERSION" ]; then
              # Python 3.12ì¸ ê²½ìš° python3.12-venv ì„¤ì¹˜ ì‹œë„
              VENV_PKG="python${PYTHON_VERSION}-venv"
              if ! dpkg -l | grep -q "^ii.*$VENV_PKG"; then
                echo "âš ï¸ Installing $VENV_PKG..."
                sudo apt update
                sudo apt install -y "$VENV_PKG" || {
                  echo "âš ï¸ $VENV_PKG not available, trying python3-venv..."
                  sudo apt install -y python3-venv
                }
              else
                echo "âœ… $VENV_PKG is already installed"
              fi
            else
              # ë²„ì „ì„ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë©´ ì¼ë°˜ python3-venv ì„¤ì¹˜
              if ! dpkg -l | grep -q "^ii.*python3-venv"; then
                echo "âš ï¸ Installing python3-venv..."
                sudo apt update
                sudo apt install -y python3-venv
              else
                echo "âœ… python3-venv is already installed"
              fi
            fi

            # ê°€ìƒ í™˜ê²½ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
            VENV_DIR="/var/www/langchain/venv"
            VENV_ACTIVATE="$VENV_DIR/bin/activate"

            # ê°€ìƒ í™˜ê²½ì´ ë¶ˆì™„ì „í•œ ê²½ìš° ì¬ìƒì„±
            if [ -d "$VENV_DIR" ] && [ ! -f "$VENV_ACTIVATE" ]; then
              echo "âš ï¸ Incomplete virtual environment detected, removing and recreating..."
              rm -rf "$VENV_DIR"
            fi

            if [ ! -d "$VENV_DIR" ]; then
              echo "ğŸ Creating Python virtual environment..."
              echo "   Python command: $PYTHON_CMD"
              echo "   Virtual environment path: $VENV_DIR"

              # ë””ë ‰í† ë¦¬ ìƒì„±
              sudo mkdir -p /var/www/langchain
              sudo chown -R ubuntu:ubuntu /var/www/langchain

              # ê°€ìƒ í™˜ê²½ ìƒì„±
              echo "   Attempting to create virtual environment..."
              if ! $PYTHON_CMD -m venv "$VENV_DIR" 2>&1; then
                echo "âš ï¸ Failed with $PYTHON_CMD, installing required packages..."
                # ensurepip ë¬¸ì œì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ venv íŒ¨í‚¤ì§€ ì¬ì„¤ì¹˜
                sudo apt update
                if [ -n "$PYTHON_VERSION" ]; then
                  sudo apt install -y "python${PYTHON_VERSION}-venv" "python${PYTHON_VERSION}-distutils" || {
                    sudo apt install -y python3-venv python3-distutils
                  }
                else
                  sudo apt install -y python3-venv python3-distutils
                fi

                # ë‹¤ì‹œ ì‹œë„
                echo "   Retrying virtual environment creation..."
                if ! $PYTHON_CMD -m venv "$VENV_DIR" 2>&1; then
                  echo "âš ï¸ Still failed, trying with python3..."
                  if ! python3 -m venv "$VENV_DIR" 2>&1; then
                    echo "âŒ Virtual environment creation failed!"
                    echo "Python version: $($PYTHON_CMD --version 2>&1 || python3 --version)"
                    echo "Installed venv packages:"
                    dpkg -l | grep python.*venv || echo "No venv packages found"
                    exit 1
                  fi
                fi
              fi

              # ê°€ìƒ í™˜ê²½ ìƒì„± í™•ì¸
              if [ ! -d "$VENV_DIR" ]; then
                echo "âŒ Virtual environment directory not created!"
                exit 1
              fi

              if [ ! -f "$VENV_ACTIVATE" ]; then
                echo "âŒ Virtual environment activate script not found!"
                echo "Checking venv directory contents..."
                ls -la "$VENV_DIR" || echo "Directory does not exist"
                ls -la "$VENV_DIR/bin" 2>/dev/null || echo "bin directory does not exist"
                exit 1
              fi

              echo "âœ… Virtual environment created successfully"
            else
              # ê°€ìƒ í™˜ê²½ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš° ì™„ì „ì„± í™•ì¸
              if [ -f "$VENV_ACTIVATE" ]; then
                echo "âœ… Virtual environment already exists and is complete"
              else
                echo "âš ï¸ Virtual environment directory exists but is incomplete, recreating..."
                rm -rf "$VENV_DIR"
                $PYTHON_CMD -m venv "$VENV_DIR" || python3 -m venv "$VENV_DIR" || {
                  echo "âŒ Failed to recreate virtual environment"
                  exit 1
                }
                echo "âœ… Virtual environment recreated successfully"
              fi
            fi

            # app ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /var/www/langchain/app

            # ê°€ìƒ í™˜ê²½ í™œì„±í™”
            echo "ğŸ”Œ Activating virtual environment..."
            if [ -f "$VENV_ACTIVATE" ]; then
              source "$VENV_ACTIVATE"
              echo "âœ… Virtual environment activated"
              echo "   Python: $(which python)"
              echo "   Python version: $(python --version)"
            else
              echo "âŒ Virtual environment activate script not found at $VENV_ACTIVATE"
              echo "Virtual environment directory contents:"
              ls -la "$VENV_DIR" 2>/dev/null || echo "Directory does not exist"
              ls -la "$VENV_DIR/bin" 2>/dev/null || echo "bin directory does not exist"
              exit 1
            fi

            # pip ì—…ê·¸ë ˆì´ë“œ
            pip install --upgrade pip

            # ì˜ì¡´ì„± ì„¤ì¹˜ (app/requirements.txt ê¸°ì¤€)
            echo "ğŸ“¦ Installing dependencies..."
            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt
            else
              echo "âŒ Error: requirements.txt not found in app directory"
              exit 1
            fi

            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ìˆëŠ” ê²½ìš°)
            if systemctl list-unit-files | grep -q langchain-api.service; then
              echo "ğŸ”„ Restarting service..."
              sudo systemctl restart langchain-api.service

              # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
              sleep 3
              if sudo systemctl is-active --quiet langchain-api.service; then
                echo "âœ… Deployment successful!"
                sudo systemctl status langchain-api.service --no-pager
              else
                echo "âŒ Deployment failed - service not running!"
                sudo journalctl -u langchain-api.service -n 50 --no-pager
                exit 1
              fi
            else
              echo "âš ï¸ Warning: langchain-api.service not found"
              echo "Service will not be restarted. Please set up the service manually."
            fi
          ENDSSH

      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ Error: EC2_HOST secret is not set"
            exit 1
          fi
          echo "ğŸ¥ Performing health check on http://$EC2_HOST/health"
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" "http://$EC2_HOST/health" || echo "000")
          if [ "$response" -eq 200 ]; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed with status $response"
            exit 1
          fi

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ Deployment completed successfully!"
          else
            echo "âŒ Deployment failed!"
          fi
